<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Warehouse Map Widget Template -->
        <template id="WarehouseMapWidgetTemplate" name="Warehouse Map Widget">
            <div class="warehouse-map-container">
                <div class="warehouse-map-toolbar">
                    <button t-on-click="switchTo2D" t-att-class="state.viewMode === '2d' ? 'active' : ''">
                        <i class="fa fa-th"/> 2D View
                    </button>
                    <button t-on-click="switchTo3D" t-att-class="state.viewMode === '3d' ? 'active' : ''">
                        <i class="fa fa-cube"/> 3D View
                    </button>
                </div>
                
                <t t-if="state.viewMode === '2d'">
                    <WarehouseMap2D context="props.context"/>
                </t>
                <t t-else="">
                    <WarehouseMap3D warehouseData="state.warehouseData"/>
                </t>
            </div>
        </template>
        
        <!-- 2D View Template -->
        <template id="WarehouseMap2DTemplate" name="Warehouse Map 2D">
            <div class="warehouse-map-2d" t-att-style="'transform: scale(' + state.zoom + ')'">
                <!-- Toolbar Controls -->
                <div class="warehouse-map-toolbar" style="top: auto; bottom: 10px;">
                    <button t-on-click="zoomIn"><i class="fa fa-plus"/> Zoom In</button>
                    <button t-on-click="zoomOut"><i class="fa fa-minus"/> Zoom Out</button>
                    <button t-on-click="resetZoom"><i class="fa fa-refresh"/> Reset</button>
                </div>
                
                <!-- Warehouse Zones -->
                <t t-if="state.warehouseData">
                    <t t-foreach="state.warehouseData.zones" t-as="zone" t-key="zone.id">
                        <div class="warehouse-zone" t-att-style="'border-left: 5px solid ' + zone.color">
                            <div class="zone-header">
                                <div class="zone-title">
                                    <i class="fa fa-map-marker"/> <t t-esc="zone.code"/> - <t t-esc="zone.name"/>
                                </div>
                                <div class="zone-info">
                                    <t t-esc="zone.aisles.length"/> Aisles
                                </div>
                            </div>
                            
                            <!-- Aisles -->
                            <t t-foreach="zone.aisles" t-as="aisle" t-key="aisle.id">
                                <div class="warehouse-aisle">
                                    <h4 style="width: 100%; color: #7f8c8d; font-size: 14px;">
                                        Aisle: <t t-esc="aisle.code"/>
                                    </h4>
                                    
                                    <!-- Racks -->
                                    <t t-foreach="aisle.racks" t-as="rack" t-key="rack.id">
                                        <div class="warehouse-rack">
                                            <div class="rack-header">
                                                Rack <t t-esc="rack.code"/>
                                            </div>
                                            
                                            <!-- Levels (from top to bottom) -->
                                            <t t-foreach="rack.levels.slice().reverse()" t-as="level" t-key="level.id">
                                                <div class="warehouse-level">
                                                    <span class="level-label">L<t t-esc="level.level_number"/></span>
                                                    <div class="warehouse-bins">
                                                        <!-- Bins -->
                                                        <t t-foreach="level.bins" t-as="bin" t-key="bin.id">
                                                            <div class="warehouse-bin"
                                                                 t-att-class="(state.highlightedBins.includes(bin.id) ? 'highlighted ' : '') + 
                                                                              (bin.is_blocked ? 'blocked ' : '') + 
                                                                              bin.state"
                                                                 t-att-style="getBinStyle(bin)"
                                                                 t-on-click="() => this.onBinClick(bin)"
                                                                 t-on-mouseenter="() => this.onBinHover(bin)"
                                                                 t-att-title="bin.name + ' - ' + bin.state">
                                                                <t t-if="bin.is_blocked">
                                                                    <i class="fa fa-ban"/>
                                                                </t>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                </div>
                            </t>
                        </div>
                    </t>
                </t>
                
                <!-- Bin Details Panel -->
                <t t-if="state.selectedBin">
                    <div class="bin-details-panel">
                        <div class="bin-details-header">
                            <i class="fa fa-inbox"/> <t t-esc="state.selectedBin.complete_name"/>
                            <button style="float: right; border: none; background: none; cursor: pointer;" 
                                    t-on-click="() => this.state.selectedBin = null">
                                <i class="fa fa-times"/>
                            </button>
                        </div>
                        
                        <div class="bin-detail-row">
                            <span class="bin-detail-label">Status:</span>
                            <span t-att-class="'bin-state-badge ' + state.selectedBin.state">
                                <t t-esc="state.selectedBin.state.toUpperCase()"/>
                            </span>
                        </div>
                        
                        <div class="bin-detail-row" t-if="state.selectedBin.is_blocked">
                            <span class="bin-detail-label">Blocked:</span>
                            <span class="bin-detail-value" style="color: red;">
                                <i class="fa fa-ban"/> YES
                            </span>
                        </div>
                        
                        <div class="bin-detail-row" t-if="state.selectedBin.current_sku">
                            <span class="bin-detail-label">SKU:</span>
                            <span class="bin-detail-value"><t t-esc="state.selectedBin.current_sku"/></span>
                        </div>
                        
                        <div class="bin-detail-row" t-if="state.selectedBin.current_lot">
                            <span class="bin-detail-label">Lot:</span>
                            <span class="bin-detail-value"><t t-esc="state.selectedBin.current_lot"/></span>
                        </div>
                        
                        <div class="bin-detail-row">
                            <span class="bin-detail-label">Quantity:</span>
                            <span class="bin-detail-value"><t t-esc="state.selectedBin.total_quantity"/></span>
                        </div>
                        
                        <div class="bin-detail-row">
                            <span class="bin-detail-label">Utilization:</span>
                            <span class="bin-detail-value">
                                <t t-esc="Math.round(state.selectedBin.utilization)"/>%
                            </span>
                        </div>
                        
                        <!-- Quants List -->
                        <t t-if="state.selectedBin.quants and state.selectedBin.quants.length">
                            <h5 style="margin-top: 15px; margin-bottom: 10px; color: #2c3e50;">Stock Details:</h5>
                            <t t-foreach="state.selectedBin.quants" t-as="quant" t-key="quant_index">
                                <div style="background: #f8f9fa; padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                                    <div><strong><t t-esc="quant.product_name"/></strong></div>
                                    <div style="font-size: 12px; color: #7f8c8d;">
                                        SKU: <t t-esc="quant.sku || 'N/A'"/>
                                    </div>
                                    <div style="font-size: 12px; color: #7f8c8d;" t-if="quant.lot_name">
                                        Lot: <t t-esc="quant.lot_name"/>
                                    </div>
                                    <div style="font-size: 12px;">
                                        Qty: <strong><t t-esc="quant.quantity"/> <t t-esc="quant.uom"/></strong>
                                        (Available: <t t-esc="quant.available_quantity"/>)
                                    </div>
                                </div>
                            </t>
                        </t>
                    </div>
                </t>
                
                <!-- Legend -->
                <div class="warehouse-legend">
                    <div class="legend-title">Bin Status Legend</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #95a5a6;"></div>
                        <span class="legend-label">Empty</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span class="legend-label">Available</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span class="legend-label">Reserved</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span class="legend-label">Full</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #34495e;"></div>
                        <span class="legend-label">Blocked</span>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- 3D View Template -->
        <template id="WarehouseMap3DTemplate" name="Warehouse Map 3D">
            <div class="warehouse-map-3d">
                <canvas t-ref="canvas3d" width="1200" height="800"></canvas>
            </div>
        </template>
    </data>
</odoo>
