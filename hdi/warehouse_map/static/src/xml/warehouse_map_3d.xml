<?xml version="1.0" encoding="utf-8"?>
<templates xml:space="preserve">
    <t t-name="warehouse_map.WarehouseMap3DView">
        <div class="warehouse-map-3d-view">
            <!-- Loading indicator -->
            <t t-if="state.loading">
                <div class="warehouse-map-3d-loading">
                    <div class="spinner"></div>
                    <div>Đang tải sơ đồ 3D...</div>
                </div>
            </t>
            
            <!-- Main 3D container -->
            <div id="warehouse-map-3d-container" t-if="!state.loading and state.mapData">
                <!-- Warehouse Selector -->
                <div class="warehouse-map-3d-selector">
                    <select class="form-select" t-on-change="(ev) => this.onWarehouseChange(ev)">
                        <option t-att-value="state.mapData.warehouse_id" selected="selected">
                            <t t-esc="state.mapData.warehouse_name"/>
                        </option>
                    </select>
                </div>
                
                <!-- Controls panel -->
                <div class="warehouse-map-3d-controls">
                    <h4>Điều khiển</h4>
                    <button class="btn btn-primary btn-sm" t-on-click="() => this.refreshMap()">
                        <i class="fa fa-refresh"/> Làm mới
                    </button>
                    <button class="btn btn-secondary btn-sm" t-on-click="() => this.showAllLevels()">
                        <i class="fa fa-layer-group"/> Hiện tất cả tầng
                    </button>
                    
                    <!-- Level selector -->
                    <div class="level-selector" t-if="state.mapData">
                        <h5 style="width: 100%; margin: 10px 0 5px 0; font-size: 13px;">Chọn tầng:</h5>
                        <t t-foreach="this.levelsArray" t-as="level_idx" t-key="level_idx">
                            <button 
                                class="btn btn-sm btn-level"
                                t-att-class="!state.showAllLevels and state.currentLevel === level_idx ? 'active' : ''"
                                t-on-click="() => this.toggleLevel(level_idx)">
                                <t t-esc="level_idx"/>
                            </button>
                        </t>
                    </div>
                    
                    <!-- Map info -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <div class="info-row">
                            <span class="info-label">Kho:</span>
                            <span class="info-value" t-esc="state.mapData.warehouse_name"/>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Kích thước:</span>
                            <span class="info-value">
                                <t t-esc="state.mapData.columns"/> x 
                                <t t-esc="state.mapData.rows"/> x 
                                <t t-esc="state.mapData.levels"/>
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Legend - giống mẫu -->
                <div class="warehouse-map-3d-legend">
                    <div class="legend-item">
                        <div class="legend-color reserved"></div>
                        <span><strong>Overload</strong></span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color partial"></div>
                        <span><strong>Almost Full</strong></span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color available"></div>
                        <span><strong>Free Space Available</strong></span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color empty"></div>
                        <span><strong>No Product/Load</strong></span>
                    </div>
                </div>
                
                <!-- Selected cell info -->
                <div class="warehouse-map-3d-info" t-if="state.selectedCell">
                    <h4>Thông tin ô</h4>
                    <div class="info-row">
                        <span class="info-label">Vị trí:</span>
                        <span class="info-value">
                            (<t t-esc="state.selectedCell.x"/>, 
                            <t t-esc="state.selectedCell.y"/>, 
                            <t t-esc="state.selectedCell.z"/>)
                        </span>
                    </div>
                    <t t-if="state.selectedCell.lotData">
                        <div class="info-row">
                            <span class="info-label">Sản phẩm:</span>
                            <span class="info-value" t-esc="state.selectedCell.lotData.product_name"/>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Mã:</span>
                            <span class="info-value" t-esc="state.selectedCell.lotData.product_code"/>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Lot:</span>
                            <span class="info-value" t-esc="state.selectedCell.lotData.lot_name"/>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Số lượng:</span>
                            <span class="info-value">
                                <t t-esc="state.selectedCell.lotData.quantity"/> 
                                <t t-esc="state.selectedCell.lotData.uom"/>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Khả dụng:</span>
                            <span class="info-value">
                                <t t-esc="state.selectedCell.lotData.available_quantity"/> 
                                <t t-esc="state.selectedCell.lotData.uom"/>
                            </span>
                        </div>
                        <div class="info-row" t-if="state.selectedCell.lotData.in_date">
                            <span class="info-label">Ngày nhập:</span>
                            <span class="info-value" t-esc="state.selectedCell.lotData.in_date"/>
                        </div>
                    </t>
                    <t t-if="state.selectedCell.isBlocked">
                        <div class="info-row">
                            <span class="info-label" style="color: #F44336;">Trạng thái:</span>
                            <span class="info-value" style="color: #F44336; font-weight: 600;">Ô bị chặn</span>
                        </div>
                    </t>
                    <t t-if="!state.selectedCell.lotData and !state.selectedCell.isBlocked">
                        <div class="info-row">
                            <span class="info-label">Trạng thái:</span>
                            <span class="info-value">Ô trống</span>
                        </div>
                    </t>
                </div>
            </div>
            
            <!-- No data message -->
            <t t-if="!state.loading and !state.mapData">
                <div class="alert alert-warning m-3">
                    <h4>Không có dữ liệu sơ đồ 3D</h4>
                    <p>Vui lòng tạo sơ đồ kho 3D trước khi xem.</p>
                </div>
            </t>
        </div>
    </t>
</templates>
